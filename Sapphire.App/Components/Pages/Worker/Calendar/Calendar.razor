@inherits DatabaseRefresh
@page "/worker/{WorkerId:guid}"
@page "/worker/{WorkerId:guid}/calendar"
@page "/worker/{WorkerId:guid}/calendar/{Year:int}"

<DefaultWindowLayout PageTitle="Workers">
    <RibbonCenterContent>
        <MudIconButton Href="@($"/worker/{WorkerId}/calendar/{Year-1}")" Size="Size.Small" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.KeyboardArrowLeft" />
        <MudText Typo="Typo.h2">@Year</MudText>
        <MudIconButton Href="@($"/worker/{WorkerId}/calendar/{Year+1}")" Size="Size.Small" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.KeyboardArrowRight" />
    </RibbonCenterContent>

    <ChildContent>
        @if (_worker is not null && Year is not null)
        {
            <MudGrid>
                <MudItem sm="12">
                    <MudGrid>
                        <MudItem sm="12">
                            <WeeklyWorkdaysView Worker="_worker" Year="Year.Value" />
                        </MudItem>
                        <MudItem sm="12">
                            <LeaveDaysView Worker="_worker" Year="Year.Value" />
                        </MudItem>
                        <MudItem sm="12">
                            @*Office Days*@
                        </MudItem>
                    </MudGrid>
                </MudItem>
                <MudItem sm="12">
                    @*Calendar*@
                </MudItem>
            </MudGrid>
        }
    </ChildContent>
</DefaultWindowLayout>

@code {
    [Inject] public required TimeZoneService Time { get; set; }
    
    [Parameter] public required Guid WorkerId { get; set; }
    [Parameter] public required int? Year { get; set; }
    
    private readonly SemaphoreSlim _updateLock = new(1, 1);
    
    private WorkerAggregate? _worker;
    
    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
        await base.OnParametersSetAsync();
    }
    
    private async Task LoadData()
    {
        await _updateLock.WaitAsync();
        try
        {
            Year ??= Time.ToLocalTime(DateTime.UtcNow).Year;
            _worker = Database.Enumerate<WorkerAggregate>().SingleOrDefault(w => w.Id == WorkerId);
            
            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            _updateLock.Release();
        }
    }
}