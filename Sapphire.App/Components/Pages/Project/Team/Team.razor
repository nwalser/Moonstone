@inherits DatabaseRefresh
@page "/project/{ProjectId:guid}/team"

<DefaultWindowLayout PageTitle="@($"{_project?.Name} - Team")">
    <SecondMenu>
        <ProjectsMenu />
    </SecondMenu>
    <ThirdMenu>
        <ProjectMenu ProjectId="ProjectId" />
    </ThirdMenu>
    
    <ChildContent>
        @if (_project is not null)
        {
            <MudGrid>
                @foreach (var worker in _workersInProject)
                {
                    <MudItem sm="12">
                        <MudCard Outlined="true" Elevation="0">
                            <MudText>@worker.Name</MudText>
                            
                            @{
                                var dailyAllocations = _project.GetDailyAllocations(Database, worker.Id);
                                var weeklyAllocations = _project.GetWeeklyAllocations(Database, worker.Id);

                                foreach (var dailyAllocation in dailyAllocations)
                                {
                                    <DailyAllocationRuleView Rule="dailyAllocation"/>
                                }

                                <MudButton OnClick="() => AddDailyRule(worker.Id)">Add Daily</MudButton>

                                foreach (var weeklyAllocation in weeklyAllocations)
                                {
                                    <WeeklyAllocationRuleView Rule="weeklyAllocation"/>
                                }

                                <MudButton OnClick="() => AddWeeklyRule(worker.Id)">Add Weekly</MudButton>
                            }
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </ChildContent>
</DefaultWindowLayout>


@code {
    [Parameter] public required Guid ProjectId { get; set; }

    private ProjectAggregate? _project;
    private List<WorkerAggregate> _workersInProject = [];

    protected override void OnLoadData()
    {
        _project = Database.Enumerate<ProjectAggregate>().Single(p => p.Id == ProjectId);
        _workersInProject = _project.GetWorkersInProject(Database).ToList();
    }

    private void AddDailyRule(Guid workerId)
    {
        var dailyRule = new DailyAllocationRule()
        {
            ProjectId = ProjectId,
            WorkerId = workerId,
            MaximalAllocation = TimeSpan.FromHours(8.5),
        };

        Database.Update(dailyRule);
    }

    private void AddWeeklyRule(Guid workerId)
    {
        var dailyRule = new WeeklyAllocationRule()
        {
            ProjectId = ProjectId,
            WorkerId = workerId,
            MaximalAllocation = TimeSpan.FromHours(8.5),
            DayOfWeek = DayOfWeek.Monday,
        };

        Database.Update(dailyRule);
    }
}