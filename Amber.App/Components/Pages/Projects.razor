@using System.Reactive.Linq
@using Amber.App.Services
@using Amber.Domain.Documents.Project
@using Moonstone

@page "/projects"

@if (Workspaces.Current is not null)
{
    @foreach (var projectDocument in Workspaces.Current.EnumerateDocuments<ProjectAggregate>())
    {
        var project = Reader.Read(projectDocument);
        
        <MudStack Row="true">
            <MudTextField T="string" Value="@project.Name" ValueChanged="v => Reader.AppendMutation(projectDocument, new ChangeName(v))" Immediate="false" />
            
            <a href="@($"/project/{projectDocument.Id}")">View</a>
        </MudStack>
    }
    
    <MudButton OnClick="CreateProject">Add Project</MudButton>
}

@code {
    [Inject] public required Workspaces Workspaces { get; set; }
    [Inject] public required Reader<ProjectAggregate> Reader { get; set; }

    protected override void OnParametersSet()
    {
        Workspaces.Current?.ExternalChange
            .ObserveOn(new SynchronizationContext())
            .Do(i => InvokeAsync(StateHasChanged));
        
        base.OnParametersSet();
    }

    private void CreateProject()
    {
        Workspaces.Current?.Create<ProjectAggregate>();
        InvokeAsync(StateHasChanged);
    }
}